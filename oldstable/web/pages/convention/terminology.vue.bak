<template>
  <div class="convention-page">
    <section class="card title-card">
      <div>
        <p class="eyebrow">Document Convention</p>
        <h1>Terminology</h1>
        <p class="reference-line">[Reference: Clause 4.1 - Terminology]</p>
        <p class="muted">
          Maintain the glossary used throughout the CRA documentation. Entries feed Section 4.1 of the DOCX builder and
          preview.
        </p>
      </div>
      <div class="title-card-actions">
        <RouterLink class="btn ghost" to="/document/preview">Go to Document Preview</RouterLink>
        <button class="btn primary" type="button" @click="openAddModal">Add Term</button>
      </div>
    </section>

    <section class="card content-card">
      <article class="template-body">
        <p class="section-heading">4.1 Terminology</p>
        <p class="reference-line">[Reference: Clause 4.1]</p>
        <p>
          All terms and definitions used in the CRA documentation align with prEN 40000-1-1 (Vocabulary) and Regulation (EU)
          2024/2847. Use this table to capture product-specific terminology and the authoritative reference.
        </p>
      </article>

      <div class="table-section">
        <div class="table-wrapper">
          <table class="terminology-table">
            <thead>
              <tr>
                <th>Term</th>
                <th>Definition</th>
                <th>Reference</th>
                <th class="action-column">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr v-if="terminologyEntries.length === 0">
                <td class="empty-state" colspan="4">No terminology captured yet.</td>
              </tr>
              <tr
                v-for="entry in terminologyEntries"
                :key="entry.id"
                class="clickable-row"
                @click="openEditModal(entry)"
              >
                <td>{{ entry.term || '‚Äî' }}</td>
                <td>{{ entry.definition || '‚Äî' }}</td>
                <td>{{ entry.reference || '‚Äî' }}</td>
                <td class="action-column" @click.stop>
                  <button class="link danger" type="button" @click="removeEntry(entry.id)">üóëÔ∏è</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <button class="btn primary" type="button" @click="openAddModal">Add Term</button>
      </div>
    </section>

    <div v-if="showModal" class="demo-modal-overlay" @click="closeModal">
      <div class="demo-modal" role="dialog" aria-modal="true" @click.stop>
        <header class="demo-modal-header">
          <h2 id="terminologyModalTitle">{{ editMode ? 'Edit Term' : 'Add Term' }}</h2>
          <button class="modal-close" type="button" aria-label="Close" @click="closeModal">√ó</button>
        </header>
        <form class="demo-modal-body" @submit.prevent="saveEntry">
          <label class="input-field">
            <span>Term</span>
            <input v-model="form.term" type="text" placeholder="Enter term" required />
          </label>
          <label class="input-field">
            <span>Definition</span>
            <textarea v-model="form.definition" rows="4" placeholder="Enter definition" required></textarea>
          </label>
          <label class="input-field">
            <span>Reference</span>
            <input v-model="form.reference" type="text" placeholder="e.g., prEN 40000-1-1" />
          </label>
          <p v-if="formError" class="form-error">{{ formError }}</p>
        </form>
        <footer class="demo-modal-footer">
          <div class="modal-footer-left">
            <button v-if="editMode" class="btn danger" type="button" @click="deleteEntry">Delete</button>
          </div>
          <div class="modal-footer-right">
            <button class="btn ghost" type="button" @click="closeModal">Cancel</button>
            <button class="btn primary" type="button" @click="saveEntry">{{ editMode ? 'Save Changes' : 'Add Term' }}</button>
          </div>
        </footer>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted, onUnmounted, reactive, ref } from 'vue'
import {
  generateTerminologyEntryId,
  loadDocumentWorkspace,
  subscribeDocumentWorkspace,
  updateDocumentConventionState,
  type DocumentConventionTerminologyEntry,
  type DocumentWorkspaceState,
} from '../../services/documentWorkspace'

const workspaceState = ref<DocumentWorkspaceState>(loadDocumentWorkspace())
let unsubscribe: (() => void) | null = null

onMounted(() => {
  unsubscribe = subscribeDocumentWorkspace((state) => {
    workspaceState.value = state
  })
})

onUnmounted(() => {
  unsubscribe?.()
})

const terminologyEntries = computed(() => workspaceState.value.documentConvention.terminologyEntries)

const showModal = ref(false)
const editMode = ref(false)
const form = reactive<DocumentConventionTerminologyEntry>({
  id: '',
  term: '',
  definition: '',
  reference: '',
})
const formError = ref('')

function openAddModal() {
  editMode.value = false
  form.id = generateTerminologyEntryId()
  form.term = ''
  form.definition = ''
  form.reference = ''
  formError.value = ''
  showModal.value = true
}

function openEditModal(entry: DocumentConventionTerminologyEntry) {
  editMode.value = true
  form.id = entry.id
  form.term = entry.term
  form.definition = entry.definition
  form.reference = entry.reference
  formError.value = ''
  showModal.value = true
}

function closeModal() {
  showModal.value = false
}

function saveEntry() {
  const trimmedTerm = form.term.trim()
  const trimmedDefinition = form.definition.trim()
  if (!trimmedTerm || !trimmedDefinition) {
    formError.value = 'Please provide both a term and definition.'
    return
  }
  const trimmedReference = form.reference.trim()
  const nextEntries = terminologyEntries.value.map((entry) => ({ ...entry }))

  if (editMode.value) {
    const index = nextEntries.findIndex((entry) => entry.id === form.id)
    if (index !== -1) {
      nextEntries[index] = {
        id: form.id,
        term: trimmedTerm,
        definition: trimmedDefinition,
        reference: trimmedReference,
      }
    }
  } else {
    nextEntries.push({
      id: form.id || generateTerminologyEntryId(),
      term: trimmedTerm,
      definition: trimmedDefinition,
      reference: trimmedReference,
    })
  }

  updateDocumentConventionState({ terminologyEntries: nextEntries })
  showModal.value = false
}

function deleteEntry() {
  removeEntry(form.id)
  closeModal()
}

function removeEntry(id: string) {
  const nextEntries = terminologyEntries.value.filter((entry) => entry.id !== id)
  updateDocumentConventionState({ terminologyEntries: nextEntries })
}
</script>

<style scoped>
.convention-page {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.eyebrow {
  text-transform: uppercase;
  letter-spacing: 0.08em;
  font-size: 0.75rem;
  color: var(--muted);
  margin: 0 0 6px 0;
}

.muted {
  color: var(--muted);
  line-height: 1.6;
  margin: 0;
}

.title-card {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 16px;
  flex-wrap: wrap;
}

.title-card-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  margin-left: auto;
  justify-content: flex-end;
}

.title-card-actions :deep(a) {
  text-decoration: none;
}

.content-card {
  display: flex;
  flex-direction: column;
  gap: 24px;
  padding: 24px;
}

.template-body {
  display: flex;
  flex-direction: column;
  gap: 12px;
  line-height: 1.6;
}

.template-body ul {
  margin: 8px 0;
  padding-left: 24px;
}

.section-heading {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text);
  margin: 0;
}

.reference-line {
  font-weight: 600;
  margin: 0;
}

.notation-section {
  border-top: 1px solid var(--panel-border);
  padding-top: 16px;
}

.subheading {
  font-weight: 700;
  margin-bottom: 12px;
}

/* Table styles for Terminology */
.table-section {
  border-top: 1px solid var(--panel-border);
  padding-top: 16px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.table-wrapper {
  overflow-x: auto;
  border-radius: 12px;
  border: 1px solid var(--panel-border);
}

.terminology-table {
  width: 100%;
  min-width: 800px;
  border-collapse: separate;
  border-spacing: 0;
}

.terminology-table thead {
  background: var(--surface-alt);
}

.terminology-table th,
.terminology-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid var(--panel-border);
}

.terminology-table th {
  font-weight: 700;
  color: var(--text);
  white-space: nowrap;
}

.terminology-table tbody tr:last-child td {
  border-bottom: none;
}

.terminology-table tbody tr.clickable-row {
  cursor: pointer;
  transition: all 0.2s ease;
}

.terminology-table tbody tr.clickable-row:hover {
  background: var(--surface-alt);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  transform: translateY(-1px);
}

.action-column {
  width: 100px;
  text-align: center !important;
}

.terminology-table .link.danger {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 8px;
  font-size: 1.2rem;
  transition: transform 0.2s, background-color 0.2s;
  border-radius: 6px;
}

.terminology-table .link.danger:hover {
  transform: scale(1.1);
  background-color: rgba(255, 59, 48, 0.1);
}

.empty-state {
  text-align: center !important;
  color: var(--text-muted);
  font-style: italic;
  padding: 32px 16px !important;
}

/* Modal styles - following ModalDemo pattern */
.demo-modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 24px;
  z-index: 50;
  backdrop-filter: blur(2px);
}

.demo-modal {
  width: min(600px, 100%);
  background: var(--panel);
  border-radius: 16px;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.25);
  display: flex;
  flex-direction: column;
  max-height: 90vh;
}

.demo-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--panel-border);
}

.demo-modal-header h2 {
  margin: 0;
  font-size: 1.3rem;
}

.demo-modal-body {
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.demo-modal-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-top: 1px solid var(--panel-border);
}

.input-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 0.95rem;
}

.input-field input,
.input-field textarea {
  border: 1px solid var(--panel-border);
  border-radius: 8px;
  padding: 10px 12px;
  background: var(--panel);
  color: var(--text);
  font-size: 0.95rem;
}

.input-field textarea {
  resize: vertical;
}

.form-error {
  color: var(--danger, #ef4444);
  font-weight: 600;
  margin: 0;
}

.modal-footer-left {
  display: flex;
  gap: 12px;
}

.modal-footer-right {
  display: flex;
  gap: 12px;
  margin-left: auto;
}

.modal-close {
  border: none;
  background: transparent;
  font-size: 24px;
  line-height: 1;
  cursor: pointer;
  color: var(--text);
}

.field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.field-label {
  font-weight: 600;
}
</style>
