# Implementation Plan

- [x] 1. Add state types and constants for Product Context Assessment
  - [x] 1.1 Add new types to `app/services/documentWorkspace/types.ts`
    - Add `AssessmentStatus`, `OverallVerdict`, `NCSeverity` types
    - Add `RequirementAssessmentEntry`, `NonConformityEntry`, `ProductContextAssessmentState` interfaces
    - Add `productContextAssessment` to `RiskManagementState` interface
    - _Requirements: 8.1, 8.2_
  - [x] 1.2 Add requirement definitions constant to `app/services/documentWorkspace/constants.ts`
    - Add `PRODUCT_CONTEXT_REQUIREMENTS` array with all Clause 6.2 requirements
    - Add `RISK_PRODUCT_CONTEXT_ASSESSMENT_SECTION_KEY` constant
    - _Requirements: 1.3, 1.4_
  - [x] 1.3 Add default state to `app/services/documentWorkspace/defaults.ts`
    - Add `defaultProductContextAssessmentState` function
    - Initialize empty assessments array, default verdict, empty summary, empty NC list
    - _Requirements: 8.2_
  - [x] 1.4 Write property test for state round-trip consistency
    - **Property 13: State round-trip consistency**
    - **Validates: Requirements 8.1, 8.2**

- [x] 2. Add cloner and updater functions for assessment state
  - [x] 2.1 Add cloner to `app/services/documentWorkspace/cloners/riskManagementCloners.ts`
    - Add `cloneProductContextAssessmentState` function
    - Ensure deep cloning of assessments and nonConformities arrays
    - _Requirements: 8.1_
  - [x] 2.2 Update `app/services/documentWorkspace/updaters/riskManagementUpdaters.ts`
    - Extend `updateRiskManagementState` to handle `productContextAssessment` updates
    - _Requirements: 8.1_
  - [x] 2.3 Export new types and functions from `app/services/documentWorkspace/index.ts`
    - Export new types, constants, and functions
    - _Requirements: 8.1_

- [x] 3. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Create the Product Context Assessment page with header and checklist table
  - [x] 4.1 Create `app/pages/risk/product-context-assessment.vue` with header card
    - Add header card with section title "Product Context - Assessment Summary"
    - Add reference "[Reference: Clause 6.2]"
    - Add navigation button to Document Preview
    - _Requirements: 1.1_
  - [x] 4.2 Add assessment checklist table structure
    - Create UTable with columns: ID, Requirement, Evidence, Status, Comments
    - Organize rows by subsections (6.2.2, 6.2.3, 6.2.4, 6.2.5)
    - Add subsection header rows
    - _Requirements: 1.2, 1.3, 1.4_
  - [x] 4.3 Implement status checkboxes in table cells
    - Add Pass/Fail checkboxes for each requirement
    - Add N/A checkbox for requirements 6.2.3-f, 6.2.3-g, 6.2.3-h
    - Implement mutual exclusivity logic
    - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_
  - [x] 4.4 Write property test for status checkbox mutual exclusivity
    - **Property 7: Status checkbox mutual exclusivity**
    - **Validates: Requirements 4.2, 4.3**

- [x] 5. Implement Evidence Selection Modal
  - [x] 5.1 Add evidence selection modal component
    - Create UModal for evidence selection
    - Display evidence entries from workspace with title, reference ID, status
    - Add empty state message when no evidence exists
    - _Requirements: 2.1, 2.2, 2.5_
  - [x] 5.2 Implement evidence cell click handler and selection logic
    - Open modal on evidence cell click
    - Update assessment entry with selected evidence ID and reference
    - Handle modal close without selection
    - _Requirements: 2.3, 2.4_
  - [x] 5.3 Write property tests for evidence selection
    - **Property 1: Evidence modal displays all tracker entries**
    - **Property 2: Evidence selection updates cell correctly**
    - **Property 3: Modal cancel preserves evidence state**
    - **Validates: Requirements 2.2, 2.3, 2.4**

- [x] 6. Implement Comments Modal
  - [x] 6.1 Add comments modal with WYSIWYG editor
    - Create UModal containing RichTextEditor
    - Pre-populate editor with existing comment content
    - Add Save/Cancel buttons
    - _Requirements: 3.1, 3.2_
  - [x] 6.2 Implement comments cell click handler and save/cancel logic
    - Open modal on comments cell click
    - Save HTML content and show truncated preview
    - Discard changes on cancel
    - _Requirements: 3.3, 3.4_
  - [x] 6.3 Write property tests for comments modal
    - **Property 4: Comments modal hydrates existing content**
    - **Property 5: Comments save persists and previews**
    - **Property 6: Comments cancel preserves state**
    - **Validates: Requirements 3.2, 3.3, 3.4**

- [x] 7. Implement Overall Verdict section
  - [x] 7.1 Add overall verdict card with radio options
    - Create card with PASS, PARTIAL, FAIL, N/A options
    - Style selected option with visual indication
    - _Requirements: 5.1_
  - [x] 7.2 Implement verdict selection and persistence
    - Handle verdict selection change
    - Persist to workspace state immediately
    - _Requirements: 5.2, 5.3_
  - [x] 7.3 Write property test for verdict persistence
    - **Property 8: Overall verdict persistence**
    - **Validates: Requirements 5.2, 5.3**

- [x] 8. Implement Summary of Findings section
  - [x] 8.1 Add summary card with WYSIWYG editor
    - Create card with RichTextEditor
    - Add "Insert Template" button
    - _Requirements: 6.1_
  - [x] 8.2 Implement template insertion and content persistence
    - Insert predefined template text on button click
    - Preserve existing content when inserting template
    - Persist HTML content to workspace
    - _Requirements: 6.2, 6.3, 6.4_
  - [x] 8.3 Write property tests for summary section
    - **Property 9: Summary content persistence**
    - **Property 10: Template insertion preserves content**
    - **Validates: Requirements 6.2, 6.4**

- [x] 9. Implement Non-Conformities section
  - [x] 9.1 Add non-conformities card with table
    - Create card with UTable for NC entries
    - Add "Add Non-Conformity" button
    - Display columns: NC ID, Requirement, Description, Severity, Corrective Action
    - _Requirements: 7.1_
  - [x] 9.2 Add non-conformity modal form
    - Create UModal with form fields
    - Add NC ID, Requirement, Description, Severity dropdown, Corrective Action fields
    - Support create and edit modes
    - _Requirements: 7.2, 7.3, 7.5_
  - [x] 9.3 Implement NC CRUD operations
    - Save new NC entries to table and workspace
    - Edit existing NC entries
    - Delete NC entries with confirmation
    - _Requirements: 7.4, 7.6_
  - [x] 9.4 Write property tests for NC operations
    - **Property 11: NC entry persistence**
    - **Property 12: NC deletion persistence**
    - **Validates: Requirements 7.4, 7.6**

- [x] 10. Implement state hydration and subscription
  - [x] 10.1 Add workspace state hydration on mount
    - Load assessment state from workspace on page mount
    - Hydrate all form fields and table data
    - _Requirements: 8.2_
  - [x] 10.2 Add workspace subscription for external changes
    - Subscribe to workspace changes
    - Update displayed data when external changes occur
    - Use hydrating flag to prevent save loops
    - _Requirements: 8.3_
  - [x] 10.3 Write property test for external state subscription
    - **Property 14: External state subscription**
    - **Validates: Requirements 8.3**

- [x] 11. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.


- [x] 12. Integrate Product Context Assessment into Preview Section Status
  - [x] 12.1 Add section status to `app/composables/usePreviewSections.ts`
    - Add `productContextAssessmentState` computed property
    - Add `risk-product-context-assessment` to `SECTION_GROUP_DEFINITIONS` under `risk-management` group
    - Create `createSectionStatus` entry for Product Context Assessment with appropriate fields
    - _Requirements: 8.1, 8.2_
  - [x] 12.2 Update section group definition
    - Add `'risk-product-context-assessment'` to the `children` array of the `risk-management` group
    - _Requirements: 8.1_

- [x] 13. Integrate Product Context Assessment into API Payload Builder
  - [x] 13.1 Update `app/utils/previewPayload.ts` to include assessment data
    - Add `productContextAssessment` extraction in `buildRiskManagementPayload`
    - Normalize assessment entries, verdict, summary, and non-conformities for API
    - Add `_product_context_assessment_has_content` check
    - _Requirements: 8.1_

- [x] 14. Add Backend Pydantic Models for Product Context Assessment
  - [x] 14.1 Add Pydantic schemas to `backend/app/schemas.py`
    - Add `RequirementAssessmentEntry` model with id, evidence_id, evidence_ref_id, status, comments_html
    - Add `NonConformityEntry` model with id, requirement_id, description, severity, corrective_action
    - Add `ProductContextAssessmentSection` model with assessments, overall_verdict, summary_of_findings_html, non_conformities
    - Add `product_context_assessment` field to `RiskManagementSection` model
    - _Requirements: 8.1_

- [x] 15. Add DOCX Builder for Product Context Assessment
  - [x] 15.1 Add assessment section builder to `backend/app/docx_builder/risk_management_builder.py`
    - Add `_product_context_assessment_has_content` function
    - Add `_append_product_context_assessment_section` function
    - Render overall verdict with visual indication
    - Render summary of findings HTML content
    - Render assessment checklist table with ID, Requirement, Evidence, Status, Comments columns
    - Render non-conformities table with NC ID, Requirement, Description, Severity, Corrective Action columns
    - _Requirements: 8.1_
  - [x] 15.2 Integrate assessment section into main builder
    - Call `_append_product_context_assessment_section` from `append_risk_management_section`
    - Add section heading "5.3 Product Context Assessment Summary"
    - Add clause reference "[Reference: Clause 6.2]"
    - _Requirements: 8.1_

- [-] 16. Final Integration Checkpoint
  - Ensure all tests pass, ask the user if questions arise.
  - Verify DOCX export includes Product Context Assessment section
  - Verify preview section status shows assessment completion state
